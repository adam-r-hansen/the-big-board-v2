name: NFL Scores & Scoring Engine V2
on:
  schedule:
    # Run every 5 minutes during NFL game days (Thu-Mon)
    - cron: '*/5 * * * 4'      # Thursday
    - cron: '*/5 * * * 0'      # Sunday  
    - cron: '*/5 * * * 1'      # Monday
    # Run every 30 minutes other days (just to catch stragglers)
    - cron: '*/30 * * * 2,3,5,6'  # Tue, Wed, Fri, Sat
  workflow_dispatch:
jobs:
  update-scores-and-standings:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Update NFL Scores (V1 Edge Function)
        env:
          SUPABASE_FUNCTION_URL: ${{ secrets.SUPABASE_FUNCTION_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Updating NFL scores and pick points..."
          for i in 1 2 3; do
            CODE=$(curl -sS -o scores.json -w "%{http_code}" -X POST \
              "$SUPABASE_FUNCTION_URL" \
              -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
              -H "Content-Type: application/json" \
              -d '{}') || true
            echo "Scores API returned HTTP $CODE"
            cat scores.json 2>/dev/null || true
            if [ "$CODE" -ge 200 ] && [ "$CODE" -lt 300 ]; then
              echo "✅ Scores updated successfully"
              break
            fi
            sleep 10
          done
          
          if [ "$CODE" -lt 200 ] || [ "$CODE" -ge 300 ]; then
            echo "❌ Failed to update scores after retries"
            exit 1
          fi
      
      - name: Update Standings
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          echo "Updating standings for all leagues..."
          CODE=$(curl -L -sS -o standings.json -w "%{http_code}" -X POST \
            "https://$VERCEL_URL/api/admin/update-standings" \
            -H "Content-Type: application/json" \
            -d '{}')
          
          echo "Standings API returned HTTP $CODE"
          cat standings.json 2>/dev/null || echo "No response body"
          
          if [ "$CODE" -ge 200 ] && [ "$CODE" -lt 300 ]; then
            echo "✅ Standings updated successfully"
          else
            echo "⚠️ Standings update failed (non-fatal, scores still updated)"
          fi
